package com.leon.baseapp.base

import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import androidx.annotation.LayoutRes
import androidx.fragment.app.Fragment
import com.cxz.multiplestatusview.MultipleStatusView
import com.leon.baseapp.R
import com.leon.baseapp.constant.Constant
import com.leon.baseapp.event.Event
import com.leon.baseapp.event.NetworkChangeEvent
import com.leon.baseapp.utils.Preference
import org.greenrobot.eventbus.EventBus
import org.greenrobot.eventbus.Subscribe
import org.greenrobot.eventbus.ThreadMode

/**
 * Created by chenxz on 2018/4/21.
 */
abstract class BaseFragment : Fragment() {

    /**
     * check login
     */
    protected var isLogin: Boolean by Preference(Constant.LOGIN_KEY, false)

    /**
     * 缓存上一次的网络状态
     */
    protected var hasNetwork: Boolean by Preference(Constant.HAS_NETWORK_KEY, true)

    /**
     * 视图是否加载完毕
     */
    private var isViewPrepare = false

    /**
     * 数据是否加载过了
     */
    private var hasLoadData = false

    /**
     * 多种状态的 View 的切换
     */
    protected var mLayoutStatusView: MultipleStatusView? = null

    /**
     * 加载布局
     */
    @LayoutRes
    abstract fun attachLayoutRes(): Int

    /**
     * 初始化 View
     */
    abstract fun initView(view: View)

    /**
     * 懒加载
     */
    open fun lazyLoad() {
        //第一次加载的时候加载等待动画
        mLayoutStatusView?.showLoading()
        doRequest()
    }

    /**
     * 请求
     */
    abstract fun doRequest()

    /**
     * 是否使用 EventBus
     */
    open val isRegisterEventBus: Boolean
        get() = false

    /**
     * 无网状态—>有网状态 的自动重连操作，子类可重写该方法
     */
    open fun doReConnected() {
        lazyLoad()
    }

    /**
     * 初始化监听器
     */
    open fun initListener() {}

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
        return inflater.inflate(attachLayoutRes(), null)
    }

    override fun setUserVisibleHint(isVisibleToUser: Boolean) {
        super.setUserVisibleHint(isVisibleToUser)
        if (isVisibleToUser) {
            lazyLoadDataIfPrepared()
        }
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        if (isRegisterEventBus) {
            EventBus.getDefault().register(this)
        }
        isViewPrepare = true
        initView(view)
        initListener()
        lazyLoadDataIfPrepared()
        mLayoutStatusView = view.findViewById(R.id.multiple_status_view)
        //多种状态切换的view 重试点击事件
        mLayoutStatusView?.setOnClickListener(mRetryClickListener)
    }

    private fun lazyLoadDataIfPrepared() {
        if (userVisibleHint && isViewPrepare && !hasLoadData) {
            lazyLoad()
            hasLoadData = true
        }
    }

    open val mRetryClickListener: View.OnClickListener = View.OnClickListener {
        lazyLoad()
    }

    /**
     * 子类重写接收到分发到事件
     */
    open fun receiveEvent(event: Any?) {}

    /**
     * 子类重写接受到分发的粘性事件
     */
    open fun receiveStickyEvent(event: Any?) {}

    @Subscribe(threadMode = ThreadMode.MAIN)
    fun onEventBusCome(event: Event<*>?) {
        if (event?.data is NetworkChangeEvent) {
            val networkChangeEvent = event.data as NetworkChangeEvent
            if (networkChangeEvent.isConnected) {
                doReConnected()
            }
        }
        event?.let { receiveEvent(it.data) }
    }

    @Subscribe(threadMode = ThreadMode.MAIN, sticky = true)
    fun onStickyEventBusCome(event: Event<*>?) {
        event?.let { receiveStickyEvent(it.data) }
    }


    override fun onDestroy() {
        super.onDestroy()
        if (isRegisterEventBus) {
            EventBus.getDefault().unregister(this)
        }
        activity?.let { BaseApplication.getRefWatcher(it)?.watch(activity) }
    }

}